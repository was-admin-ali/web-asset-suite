{% extends "admin/admin_base.html" %}

{% block admin_title %}Dashboard Overview{% endblock %}

{% block admin_content %}
<h1>Dashboard Overview</h1>
<p class="tool-subtitle" style="margin-bottom: 30px;">A quick-glance health check of your application's key metrics.</p>

<!-- Stat Cards Grid -->
<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
    <!-- Active Users -->
    <div class="stat-card">
        <h3>Daily Active Users (DAU)</h3>
        <span class="stat-number">{{ dau }}</span>
    </div>
    <div class="stat-card">
        <h3>Monthly Active Users (MAU)</h3>
        <span class="stat-number">{{ mau }}</span>
    </div>
    <!-- New Signups -->
    <div class="stat-card">
        <h3>New Users (24h)</h3>
        <span class="stat-number">{{ new_users_day }}</span>
    </div>
    <div class="stat-card">
        <h3>New Users (7d)</h3>
        <span class="stat-number">{{ new_users_week }}</span>
    </div>
    <div class="stat-card">
        <h3>New Users (30d)</h3>
        <span class="stat-number">{{ new_users_month }}</span>
    </div>
    <!-- Churn/Retention -->
    <div class="stat-card">
        <h3>Churn Rate (30d)</h3>
        <span class="stat-number" style="color: #F87171;">{{ "%.1f"|format(churn_rate) }}%</span>
    </div>
</div>

<!-- Conversion Funnel Section -->
<div class="admin-main-panel" style="margin-top: 40px; padding: 30px;">
    <h2 class="admin-panel-title">Conversion Funnel (Last 30 Days)</h2>
    <div class="funnel-container" style="display: flex; align-items: center; justify-content: space-between; gap: 20px; margin-top: 20px;">
        <div class="funnel-step" style="text-align: center;">
            <span style="font-size: 2.5rem; font-weight: 800; color: var(--accent-primary);">{{ "{:,}".format(funnel_data.visitors) }}</span>
            <h4 style="margin: 5px 0 0 0; color: var(--text-secondary);">Visitors</h4>
        </div>
        <span style="font-size: 2rem; color: var(--text-secondary);">&rarr;</span>
        <div class="funnel-step" style="text-align: center;">
            <span style="font-size: 2.5rem; font-weight: 800; color: var(--accent-primary);">{{ "{:,}".format(funnel_data.signups) }}</span>
            <h4 style="margin: 5px 0 0 0; color: var(--text-secondary);">Total Signups</h4>
        </div>
        <span style="font-size: 2rem; color: var(--text-secondary);">&rarr;</span>
        <div class="funnel-step" style="text-align: center;">
            <span style="font-size: 2.5rem; font-weight: 800; color: var(--accent-secondary);">{{ "{:,}".format(funnel_data.active_users) }}</span>
            <h4 style="margin: 5px 0 0 0; color: var(--text-secondary);">Active Users (MAU)</h4>
        </div>
    </div>
</div>


<!-- Main Analytics Area -->
<div class="admin-section-grid">
    <!-- User Growth Chart (Left Side) -->
    <div class="admin-main-panel">
        <h2 class="admin-panel-title">New User Signups (Last 30 Days)</h2>
        <div class="chart-container">
            <canvas id="user-growth-chart" 
                    data-labels="{{ chart_labels | tojson | e }}" 
                    data-signups="{{ signup_data | tojson | e }}">
            </canvas>
        </div>
    </div>

    <!-- Side Panels (Right Side) -->
    <div class="admin-side-panel">
        <!-- START: NEW ACTIVE VS INACTIVE CHART -->
        <div class="admin-main-panel">
            <h2 class="admin-panel-title">Active vs. Inactive Users</h2>
             <div class="chart-container" style="height: 250px;">
                <canvas id="active-users-chart" data-values="{{ active_v_inactive | tojson | e }}"></canvas>
            </div>
        </div>
        <!-- END: NEW ACTIVE VS INACTIVE CHART -->

        <!-- Tool Usage Breakdown -->
        <div class="admin-table-wrapper" style="margin-top: 0;">
            <h2 class="admin-panel-title" style="padding: 20px; margin: 0; border-bottom: 1px solid var(--border-color);">Top Tools Used</h2>
            <table class="admin-table">
                <tbody>
                    {% for tool, count in tool_usage_counts.items() %}
                    <tr>
                        <td style="text-transform: capitalize;">{{ tool }}</td>
                        <td style="text-align: right; font-weight: 700;">{{ count }} uses</td>
                    </tr>
                    {% else %}
                    <tr><td>No tool usage recorded yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Global User Map -->
<div class="admin-main-panel" style="margin-top: 30px;">
    <h2 class="admin-panel-title">Global Users by Country (Last 30 Days from GA)</h2>
    <div class="chart-container" style="height: 500px;">
        <!-- IMPROVED CHECK: Specifically checks for user_map_data -->
        <canvas id="user-map-chart" data-map="{{ ga_data.user_map_data | tojson | e if ga_data and ga_data.user_map_data else '{}' }}"></canvas>
    </div>
</div>


<!-- Chart.js and Geo Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-geo@4.3.0/build/index.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const textColor = 'rgba(237, 237, 237, 0.8)';
    const borderColor = 'rgba(51, 51, 51, 0.8)';

    // --- User Growth Chart ---
    const growthCanvas = document.getElementById('user-growth-chart');
    if (growthCanvas) {
        try {
            const labels = JSON.parse(growthCanvas.dataset.labels);
            const signupData = JSON.parse(growthCanvas.dataset.signups);
            const ctx = growthCanvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(74, 105, 255, 0.4)');
            gradient.addColorStop(1, 'rgba(74, 105, 255, 0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'New Users',
                        data: signupData,
                        borderColor: 'var(--accent-primary)',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'var(--accent-primary)',
                        pointBorderColor: 'var(--bg-secondary)',
                        pointHoverRadius: 7,
                        pointHoverBorderWidth: 3,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { color: textColor, precision: 0 }, grid: { color: borderColor } }, x: { ticks: { color: textColor }, grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        } catch (e) {
            console.error("Error parsing user growth chart data:", e);
            growthCanvas.parentElement.innerHTML = '<p style="color: var(--text-secondary);">Could not load chart data.</p>';
        }
    }

    // --- NEW: Active vs Inactive Users Chart ---
    const activeCanvas = document.getElementById('active-users-chart');
    if (activeCanvas) {
        try {
            const activeData = JSON.parse(activeCanvas.dataset.values);
            new Chart(activeCanvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Active (30d)', 'Inactive'],
                    datasets: [{
                        data: [activeData.active, activeData.inactive],
                        backgroundColor: ['var(--accent-secondary)', '#4B5563'],
                        borderColor: 'var(--bg-secondary)',
                        borderWidth: 4,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: textColor, boxWidth: 15 } } }
                }
            });
        } catch(e) {
            console.error("Error parsing active user data:", e);
        }
    }

    // --- Global User Map Chart (IMPROVED SCRIPT) ---
    const mapCanvas = document.getElementById('user-map-chart');
    if (mapCanvas) {
        try {
            const mapData = JSON.parse(mapCanvas.dataset.map);
            if (Object.keys(mapData).length > 0) {
                fetch('https://unpkg.com/world-atlas/countries-50m.json')
                    .then((r) => r.json())
                    .then((data) => {
                        const countries = ChartGeo.topojson.feature(data, data.objects.countries).features;
                        new Chart(mapCanvas.getContext('2d'), {
                            type: 'choropleth',
                            data: {
                                labels: countries.map((d) => d.properties.name),
                                datasets: [{
                                    label: 'Users by Country',
                                    data: countries.map((d) => ({ feature: d, value: mapData[d.properties.name] || 0 })),
                                }]
                            },
                            options: {
                                showOutline: true,
                                showGraticule: true,
                                plugins: { legend: { display: false } },
                                scales: {
                                    xy: { projection: 'equalEarth' },
                                    color: {
                                        axis: 'x',
                                        interpolate: (value) => {
                                            const colorStops = [ { val: 0, color: '#1C1C1C' }, { val: 1, color: '#4A69FF' } ];
                                            const i = colorStops.slice(1).findIndex(stop => stop.val >= value);
                                            if (i === -1) return colorStops[colorStops.length - 1].color;
                                            const start = colorStops[i], end = colorStops[i + 1];
                                            const t = (value - start.val) / (end.val - start.val);
                                            const mix = (c1, c2, t) => Math.round(c1 * (1 - t) + c2 * t);
                                            const hexToRgb = hex => hex.match(/\w\w/g).map(x => parseInt(x, 16));
                                            const rgbToHex = (r, g, b) => `#${[r, g, b].map(x => x.toString(16).padStart(2, '0')).join('')}`;
                                            const [r1, g1, b1] = hexToRgb(start.color.substring(1));
                                            const [r2, g2, b2] = hexToRgb(end.color.substring(1));
                                            return rgbToHex(mix(r1, r2, t), mix(g1, g2, t), mix(b1, b2, t));
                                        }
                                    }
                                }
                            }
                        });
                    });
            } else {
                 mapCanvas.parentElement.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No Google Analytics location data available to display the map.</p>';
            }
        } catch (e) {
            console.error("Error parsing map data:", e);
            mapCanvas.parentElement.innerHTML = '<p style="color: var(--text-secondary);">Could not load map data.</p>';
        }
    }
});
</script>
{% endblock %}