{% extends "admin/admin_base.html" %}

{% block admin_title %}User Details{% endblock %}

{% block admin_content %}
<div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px;">
    <a href="{{ url_for('manage_users') }}" class="btn btn-secondary">&larr; Back to User List</a>
    <h1>User Details</h1>
</div>

<div class="admin-section-grid" style="grid-template-columns: 1fr 2fr; align-items: flex-start;">
    <!-- Left Side: Profile Info & Actions -->
    <div class="admin-side-panel">
        <div class="admin-main-panel">
            <h2 class="admin-panel-title">Profile Information</h2>
            <p><strong>Name:</strong> {{ user.first_name or '' }} {{ user.last_name or '' }}</p>
            <p><strong>Username:</strong> {{ user.username or 'N/A' }}</p>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>Role:</strong> <span style="text-transform: capitalize;">{{ user.role }}</span></p>
            <p><strong>Status:</strong> <span style="text-transform: capitalize;">{{ user.status }}</span></p>
            <p><strong>Signup Date:</strong> {{ user.created_at.strftime('%b %d, %Y') }}</p>
            <p><strong>Last Login:</strong> {{ user.last_seen.strftime('%b %d, %Y %H:%M') if user.last_seen else 'Never' }}</p>
        </div>
        <div class="admin-main-panel">
            <h2 class="admin-panel-title">Actions</h2>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-secondary">Edit User Details</a>
                <form action="{{ url_for('toggle_user_status', user_id=user.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn {% if user.status == 'active' %}btn-secondary{% else %}btn-primary{% endif %}" style="width: 100%;">
                        {% if user.status == 'active' %}Suspend User{% else %}Activate User{% endif %}
                    </button>
                </form>
                {% if user.id != current_user.id %}
                <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to permanently delete this user and all their data?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-secondary" style="width: 100%; background-color: #8C1C1B; color: white;">Delete User</button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Side: Stats and Activity -->
    <div class="admin-main-panel">
        <!-- Usage Stats -->
        <h2 class="admin-panel-title">Usage Statistics</h2>
        {% if usage_stats %}
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-top: 0;">
            {% for tool, count in usage_stats.items() %}
                <div class="stat-card" style="padding: 20px;">
                    <h3 style="text-transform: capitalize;">{{ tool }} Uses</h3>
                    <span class="stat-number" style="font-size: 2.5rem;">{{ count }}</span>
                </div>
            {% endfor %}
            </div>
        {% else %}
            <p style="color: var(--text-secondary);">This user has not used any tools yet.</p>
        {% endif %}

        <!-- Activity Log -->
        <h2 class="admin-panel-title" style="margin-top: 40px;">Recent Activity Log</h2>
        <div class="admin-table-wrapper" style="margin-top: 0;">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Timestamp (UTC)</th>
                        <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in activity_log.items %}
                    <tr>
                        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td style="text-transform: capitalize;">{{ log.action.replace('_', ' ') }}</td>
                        <td style="color: var(--text-secondary);">{{ log.details | truncate(50) if log.details }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" style="text-align: center; padding: 20px;">No activity recorded.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Activity Log Pagination -->
        {% if activity_log.pages > 1 %}
        <div style="margin-top: 20px; text-align: center;">
            {% if activity_log.has_prev %}<a href="{{ url_for('view_user', user_id=user.id, page=activity_log.prev_num) }}" class="btn btn-secondary">&laquo; Newer</a>{% endif %}
            <span style="padding: 0 15px; color: var(--text-secondary);">Page {{ activity_log.page }} of {{ activity_log.pages }}</span>
            {% if activity_log.has_next %}<a href="{{ url_for('view_user', user_id=user.id, page=activity_log.next_num) }}" class="btn btn-secondary">Older &raquo;</a>{% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}